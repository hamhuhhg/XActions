<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XActions - لوحة الأدوات المتقدمة</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#f0fdfa',
              100: '#ccfbf1',
              400: '#2dd4bf',
              500: '#14b8a6',
              600: '#0d9488',
              900: '#134e4a',
            },
            darkmain: '#0f172a',
            darkcard: '#1e293b',
            darkborder: '#334155'
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* JSON formatting highlighting */
    .json-key {
      color: #2dd4bf;
    }

    .json-string {
      color: #fbbf24;
    }

    .json-number {
      color: #f87171;
    }

    .json-boolean {
      color: #a78bfa;
    }

    .json-null {
      color: #9ca3af;
    }
  </style>
</head>

<body
  class="bg-darkmain text-slate-200 font-sans antialiased min-h-screen flex selection:bg-brand-500 selection:text-white">
  <!-- Sidebar Navigation -->
  <aside
    class="w-64 bg-darkcard border-r border-darkborder flex flex-col h-screen sticky top-0 shadow-2xl z-20 transition-all duration-300">
    <div class="p-6 flex items-center gap-3 border-b border-darkborder">
      <div
        class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-400 to-blue-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
        <i class="fa-brands fa-x-twitter text-white text-xl"></i>
      </div>
      <div>
        <h1 class="font-bold text-xl tracking-tight text-white">XActions</h1>
        <p class="text-xs text-brand-400 font-medium tracking-wider uppercase">أدوات متقدمة</p>
      </div>
    </div>
    <div class="flex-1 overflow-y-auto py-4 px-3 space-y-6">
      <!-- Data Scrapers Section -->
      <div>
        <h2 class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">استخراج البيانات</h2>
        <nav class="space-y-1" id="nav-scrapers">
          <!-- Nav items will be populated by JS -->
        </nav>
      </div>
      <!-- Automation Tools Section -->
      <div>
        <h2 class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">بوتات الأتمتة</h2>
        <nav class="space-y-1" id="nav-automation">
          <!-- Nav items will be populated by JS -->
        </nav>
      </div>
    </div>
    <div class="p-4 border-t border-darkborder">
      <a href="/dashboard"
        class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors w-full text-sm">
        <i class="fa-solid fa-arrow-right"></i>
        العودة للقائمة الرئيسية
      </a>
    </div>
  </aside>
  <!-- Main Content Area -->
  <main
    class="flex-1 flex flex-col h-screen overflow-hidden bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wMikiLz48L3N2Zz4=')]">
    <!-- Headerbar -->
    <header class="h-20 glass-panel border-b border-darkborder flex items-center justify-between px-8 z-10">
      <div>
        <h2 id="current-tool-title" class="text-2xl font-bold text-white flex items-center gap-3">
          <i class="fa-solid fa-bolt text-brand-400"></i>
          اختر أداة
        </h2>
        <p id="current-tool-desc" class="text-sm text-slate-400 mt-1">اختر أداة من الشريط الجانبي للبدء.</p>
      </div>
      <div class="flex items-center gap-4">
        <!-- Auth Token Quick Set -->
        <div class="relative group">
          <button
            class="bg-darkcard border border-darkborder hover:border-brand-500/50 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
            <i class="fa-solid fa-key text-brand-400"></i>
            رمز المصادقة
            <i class="fa-solid fa-chevron-down text-xs opacity-50"></i>
          </button>
          <!-- Dropdown for Auth Token -->
          <div
            class="absolute left-0 mt-2 w-80 bg-darkcard border border-darkborder rounded-xl shadow-2xl p-4 hidden group-hover:block z-50">
            <label class="block text-xs font-medium text-slate-400 mb-1">رمز auth_token الخاص بـ X.com (<a
                href="/docs#auth" target="_blank" class="text-brand-400 hover:underline">ما هو هذا الرمز؟</a>)</label>
            <input type="password" id="global-auth-token" placeholder="ألصق ملف تعريف الارتباط auth_token هنا..."
              class="w-full bg-slate-900 border border-darkborder rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all font-mono"
              dir="ltr">
            <button onclick="saveAuthToken()"
              class="mt-3 w-full bg-brand-600 hover:bg-brand-500 text-white font-medium py-2 rounded-lg text-sm transition-colors">
              حفظ الرمز محلياً
            </button>
          </div>
        </div>
      </div>
    </header>
    <!-- Dynamic Workspace -->
    <div class="flex-1 overflow-y-auto p-8 relative">
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- Welcome State (Visible initially) -->
        <div id="welcome-state"
          class="flex flex-col items-center justify-center h-[60vh] text-center max-w-2xl mx-auto text-right">
          <div
            class="w-24 h-24 bg-darkcard rounded-2xl flex items-center justify-center mb-6 shadow-xl border border-darkborder relative mx-auto">
            <div class="absolute inset-0 bg-brand-500 rounded-2xl blur-xl opacity-20 animate-pulse-slow">
            </div>
            <i class="fa-solid fa-wand-magic-sparkles text-4xl text-brand-400"></i>
          </div>
          <h2 class="text-3xl font-bold text-white mb-4 text-center">مرحباً بك في أدوات XActions المتقدمة</h2>
          <p class="text-slate-400 text-lg mb-8 text-center">نفذ عمليات استخراج وأتمتة قوية مباشرة من متصفحك دون الحاجة
            لسطر الأوامر.</p>
          <div class="grid grid-cols-2 gap-4 w-full">
            <div class="bg-darkcard p-4 rounded-xl border border-darkborder flex items-start gap-4 text-right">
              <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center shrink-0">
                <i class="fa-solid fa-database text-blue-400"></i>
              </div>
              <div>
                <h3 class="text-white font-medium">استخراج البيانات</h3>
                <p class="text-xs text-slate-400 mt-1">احصل على المتابعين، التغريدات، والملفات الشخصية فوراً.</p>
              </div>
            </div>
            <div class="bg-darkcard p-4 rounded-xl border border-darkborder flex items-start gap-4 text-right">
              <div class="w-10 h-10 rounded-lg bg-brand-500/10 flex items-center justify-center shrink-0">
                <i class="fa-solid fa-robot text-brand-400"></i>
              </div>
              <div>
                <h3 class="text-white font-medium">أتمتة الإجراءات</h3>
                <p class="text-xs text-slate-400 mt-1">الإعجاب التلقائي، إلغاء المتابعة الجماعي، والنمو الذكي.</p>
              </div>
            </div>
          </div>
        </div>
        <!-- Tool Form (Hidden initially) -->
        <div id="tool-workspace" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- Configuration Panel -->
          <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-2xl p-6 shadow-xl">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i class="fa-solid fa-sliders text-slate-400"></i>
                الإعدادات
              </h3>
              <!-- Dynamic Form Injected Here -->
              <form id="dynamic-form" class="space-y-4">
                <!-- Inputs injected via JS -->
              </form>
              <div class="mt-8">
                <button id="run-btn"
                  class="w-full relative group overflow-hidden rounded-xl bg-brand-600 hover:bg-brand-500 text-white font-medium py-3 px-4 shadow-lg shadow-brand-500/25 transition-all transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
                  <span class="relative z-10 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-play"></i>
                    <span id="run-btn-text">تنفيذ المهمة</span>
                  </span>
                  <!-- Hover effect -->
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-brand-400 to-blue-500 opacity-0 group-hover:opacity-100 transition-opacity">
                  </div>
                </button>
              </div>
            </div>
            <!-- Status/Usage Card -->
            <div class="bg-darkcard rounded-2xl p-5 border border-darkborder shadow-xl">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-slate-300">حالة المصادقة</span>
                <span id="auth-status-badge"
                  class="px-2 py-1 rounded-md text-xs font-medium bg-slate-800 text-slate-400 flex items-center gap-1.5">
                  <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> غير محدد
                </span>
              </div>
              <p class="text-xs text-slate-500 leading-relaxed">بعض مهام الأتمتة تتطلب رمز مصادقة نشط (auth_token). قم
                بتعيينه من القائمة العلوية.</p>
            </div>
          </div>
          <!-- Results Terminal -->
          <div class="lg:col-span-8 flex flex-col h-[calc(100vh-12rem)]">
            <div
              class="glass-panel rounded-t-2xl px-4 py-3 border-b border-darkborder flex items-center justify-between shadow-sm">
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-terminal text-slate-400"></i>
                <span class="text-sm font-medium text-slate-200">مخرجات النظام</span>
              </div>
              <div class="flex gap-2" id="export-controls" style="display: none;">
                <button onclick="copyResults()"
                  class="p-1.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded transition-colors tooltip"
                  title="نسخ للائحة">
                  <i class="fa-regular fa-copy"></i>
                </button>
                <button onclick="downloadJSON()"
                  class="p-1.5 text-slate-400 hover:text-brand-400 hover:bg-brand-500/10 rounded transition-colors tooltip"
                  title="تحميل كملف JSON">
                  <i class="fa-solid fa-download"></i>
                </button>
              </div>
            </div>
            <div
              class="bg-[#0b1120] border-x border-b border-darkborder rounded-b-2xl flex-1 p-4 overflow-y-auto relative shadow-inner font-mono text-sm leading-relaxed text-left"
              id="terminal-output" dir="ltr">
              <div class="text-slate-500 italic flex items-center justify-center h-full">في انتظار التنفيذ...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- UI Logic -->
  <script>
    // Store current data
    let currentToolId = null;
    let lastResultData = null;
    // Tool Configurations
    const tools = {
      // --- SCRAPERS ---
      'profile': {
        id: 'profile',
        type: 'scraper',
        title: 'مستخرج الملف الشخصي',
        desc: 'الحصول على معلومات شاملة لملف شخصي محدد على X/Twitter.',
        icon: 'fa-regular fa-id-card',
        color: 'text-blue-400',
        endpoint: '/api/new_api/profile',
        method: 'GET',
        inputs: [
          { id: 'username', label: 'اسم المستخدم المستهدف (بدون @)', type: 'text', placeholder: 'elonmusk', prepend: '@', required: true }
        ]
      },
      'followers': {
        id: 'followers',
        type: 'scraper',
        title: 'مستخرج المتابعين',
        desc: 'استخراج قائمة المستخدمين الذين يتابعون حساباً محدداً.',
        icon: 'fa-solid fa-users',
        color: 'text-indigo-400',
        endpoint: '/api/new_api/followers',
        method: 'GET',
        inputs: [
          { id: 'username', label: 'اسم المستخدم المستهدف', type: 'text', placeholder: 'elonmusk', prepend: '@', required: true },
          { id: 'limit', label: 'الحد الأقصى للنتائج', type: 'number', placeholder: '100', defaultValue: 100 }
        ]
      },
      'tweets': {
        id: 'tweets',
        type: 'scraper',
        title: 'محمل التغريدات',
        desc: 'استخراج التغريدات الأخيرة من يوميات ملف شخصي محدد.',
        icon: 'fa-regular fa-comment-dots',
        color: 'text-sky-400',
        endpoint: '/api/new_api/tweets',
        method: 'GET',
        inputs: [
          { id: 'username', label: 'اسم المستخدم المستهدف', type: 'text', placeholder: 'SpaceX', prepend: '@', required: true },
          { id: 'limit', label: 'أقصى عدد للتغريدات', type: 'number', placeholder: '50', defaultValue: 50 },
          { id: 'includeReplies', label: 'تضمين الردود في الاستخراج؟', type: 'checkbox', defaultValue: false }
        ]
      },
      'search': {
        id: 'search',
        type: 'scraper',
        title: 'استعلام البحث',
        desc: 'إجراء بحث متقدم في تويتر واستخراج النتائج.',
        icon: 'fa-solid fa-magnifying-glass',
        color: 'text-teal-400',
        endpoint: '/api/new_api/search',
        method: 'GET',
        inputs: [
          { id: 'query', label: 'كلمة البحث أو استعلام متقدم', type: 'text', placeholder: 'AI agents min_faves:1000', icon: 'fa-solid fa-search', required: true },
          { id: 'limit', label: 'الحد الأقصى للنتائج', type: 'number', placeholder: '50', defaultValue: 50 },
          { id: 'filter', label: 'نوع التصفية', type: 'select', options: ['latest', 'top', 'people', 'photos', 'videos'], defaultValue: 'latest' }
        ]
      },
      'hashtag': {
        id: 'hashtag',
        type: 'scraper',
        title: 'مستخرج الهاشتاجات',
        desc: 'استخراج أفضل التغريدات الحديثة لهاشتاج محدد.',
        icon: 'fa-solid fa-hashtag',
        color: 'text-purple-400',
        endpoint: '/api/new_api/hashtag',
        method: 'GET',
        inputs: [
          { id: 'tag', label: 'الهاشتاج (بدون #)', type: 'text', placeholder: 'technology', prepend: '#', required: true },
          { id: 'limit', label: 'الحد الأقصى للنتائج', type: 'number', placeholder: '50', defaultValue: 50 },
          { id: 'filter', label: 'ترتيب الفرز', type: 'select', options: ['latest', 'top'], defaultValue: 'latest' }
        ]
      },
      'thread': {
        id: 'thread',
        type: 'scraper',
        title: 'مستخرج السلاسل',
        desc: 'تحميل سلسلة تغريدات كاملة من رابط تغريدة واحدة.',
        icon: 'fa-solid fa-bars-staggered',
        color: 'text-amber-400',
        endpoint: '/api/new_api/thread',
        method: 'GET',
        inputs: [
          { id: 'url', label: 'رابط التغريدة', type: 'text', placeholder: 'https://x.com/username/status/12345...', required: true }
        ]
      },
      'media': {
        id: 'media',
        type: 'scraper',
        title: 'مستخرج الوسائط',
        desc: 'استخراج الصور والفيديوهات من ملف مستخدم.',
        icon: 'fa-regular fa-image',
        color: 'text-pink-400',
        endpoint: '/api/new_api/media',
        method: 'GET',
        inputs: [
          { id: 'username', label: 'اسم المستخدم المستهدف', type: 'text', placeholder: 'SpaceX', prepend: '@', required: true },
          { id: 'limit', label: 'الحد الأقصى للوسائط', type: 'number', placeholder: '50', defaultValue: 50 }
        ]
      },
      // --- AUTOMATION (Bots) ---
      'autoPoster': {
        id: 'autoPoster',
        type: 'action',
        title: 'الناشر التلقائي (فردي/جماعي)',
        desc: 'نشر التغريدات تلقائياً. افصل بين عدة تغريدات بـ --- للنشر الجماعي.',
        icon: 'fa-solid fa-paper-plane',
        color: 'text-indigo-400',
        endpoint: '/api/new_api/run',
        method: 'POST',
        requiresAuth: true,
        scriptName: 'autoPoster',
        inputs: [
          { id: 'tweets', label: 'محتوى التغريدة (أضف مربعات للنشر الجماعي)', type: 'textarea-list', required: true }
        ]
      },
      'autoLike': {
        id: 'autoLike',
        type: 'action',
        title: 'بوت الإعجاب التلقائي',
        desc: 'الإعجاب التلقائي بالتغريدات بناءً على كلمات مفتاحية معينة أو من مستخدم مستهدف لبناء التفاعل.',
        icon: 'fa-solid fa-heart',
        color: 'text-rose-400',
        endpoint: '/api/new_api/run',
        method: 'POST',
        requiresAuth: true,
        scriptName: 'autoLike',
        inputs: [
          { id: 'target_type', label: 'نوع الاستهداف', type: 'select', options: ['keyword', 'user_timeline'], defaultValue: 'keyword' },
          { id: 'target_value', label: 'قيمة الاستهداف (كلمة مفتاحية أو اسم مستخدم)', type: 'text', placeholder: 'ChatGPT', required: true },
          { id: 'limit', label: 'أقصى عدد للإعجابات في كل تشغيل', type: 'number', placeholder: '10', defaultValue: 10 }
        ]
      },
      'smartUnfollow': {
        id: 'smartUnfollow',
        type: 'action',
        title: 'إلغاء المتابعة الجماعي الذكي',
        desc: 'إزالة المتابعة تلقائياً للمستخدمين الذين لا يتابعونك، مع الاحتفاظ بالمتابعين المتبادلين بأمان.',
        icon: 'fa-solid fa-user-minus',
        color: 'text-orange-400',
        endpoint: '/api/new_api/run',
        method: 'POST',
        requiresAuth: true,
        scriptName: 'unfollowNonFollowers',
        inputs: [
          { id: 'limit', label: 'أقصى عدد للإلغاء المتابعة', type: 'number', placeholder: '50', defaultValue: 50 }
        ]
      },
      'autoRetweet': {
        id: 'autoRetweet',
        type: 'action',
        title: 'بوت إعادة التغريد التلقائي',
        desc: 'إعادة التغريد تلقائياً من مستخدم أو بناءً على كلمة مفتاحية.',
        icon: 'fa-solid fa-retweet',
        color: 'text-green-400',
        endpoint: '/api/new_api/run',
        method: 'POST',
        requiresAuth: true,
        scriptName: 'autoRetweet',
        inputs: [
          { id: 'target_type', label: 'نوع الاستهداف', type: 'select', options: ['keyword', 'user_timeline'], defaultValue: 'keyword' },
          { id: 'target_value', label: 'قيمة الاستهداف (كلمة مفتاحية أو اسم مستخدم)', type: 'text', placeholder: 'AI', required: true },
          { id: 'limit', label: 'أقصى عدد لإعادة التغريد', type: 'number', placeholder: '10', defaultValue: 10 }
        ]
      },
      'autoFollow': {
        id: 'autoFollow',
        type: 'action',
        title: 'بوت المتابعة التلقائية',
        desc: 'متابعة جماعية للمستخدمين الذين غردوا عن كلمة مفتاحية معينة.',
        icon: 'fa-solid fa-user-plus',
        color: 'text-emerald-400',
        endpoint: '/api/new_api/run',
        method: 'POST',
        requiresAuth: true,
        scriptName: 'autoFollow',
        inputs: [
          { id: 'keyword', label: 'الكلمة المفتاحية للبحث عن المستخدمين', type: 'text', placeholder: 'Web3', required: true },
          { id: 'limit', label: 'أقصى عدد للمتابعات', type: 'number', placeholder: '20', defaultValue: 20 }
        ]
      },
      'autoComment': {
        id: 'autoComment',
        type: 'action',
        title: 'بوت الردود التلقائية',
        desc: 'الرد التلقائي على التغريدات التي تطابق كلمة مفتاحية برسالة محددة مسبقاً.',
        icon: 'fa-solid fa-reply',
        color: 'text-violet-400',
        endpoint: '/api/new_api/run',
        method: 'POST',
        requiresAuth: true,
        scriptName: 'autoComment',
        inputs: [
          { id: 'target_type', label: 'نوع الاستهداف', type: 'select', options: ['keyword', 'user_timeline'], defaultValue: 'keyword' },
          { id: 'target_value', label: 'الاستهداف للرد (كلمة أو مستخدم)', type: 'text', placeholder: 'AI', required: true },
          { id: 'comment_text', label: 'رسالة الرد', type: 'text', placeholder: 'Great post!', required: true },
          { id: 'limit', label: 'أقصى عدد للردود', type: 'number', placeholder: '5', defaultValue: 5 }
        ]
      }
    };
    // Initialize UI
    document.addEventListener('DOMContentLoaded', () => {
      renderSidebarNav();
      checkAuthToken();
      // Handle Run Button
      document.getElementById('run-btn').addEventListener('click', executeTool);
    });
    // Setup Sidebar Menu
    function renderSidebarNav() {
      const scrapersNav = document.getElementById('nav-scrapers');
      const automationNav = document.getElementById('nav-automation');
      Object.values(tools).forEach(tool => {
        const navItem = document.createElement('a');
        navItem.href = '#';
        navItem.className = `flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 ${tool.type === 'action' ? 'hover:bg-rose-500/10 hover:text-rose-400 text-slate-400' : 'hover:bg-brand-500/10 hover:text-brand-400 text-slate-400'}`;
        navItem.id = `nav-item-${tool.id}`;
        navItem.onclick = (e) => {
          e.preventDefault();
          selectTool(tool.id);
        };
        navItem.innerHTML = `
                    <i class="${tool.icon} w-5 text-center ${tool.color} opacity-70 group-hover:opacity-100"></i>
                    ${tool.title}
                    ${tool.requiresAuth ? '<i class="fa-solid fa-lock text-[10px] ml-auto opacity-50" title="Requires Auth Token"></i>' : ''}
                `;
        if (tool.type === 'scraper') {
          scrapersNav.appendChild(navItem);
        } else {
          automationNav.appendChild(navItem);
        }
      });
    }
    // Handle Tool Selection
    function selectTool(toolId) {
      currentToolId = toolId;
      const tool = tools[toolId];
      // UI Updates
      document.getElementById('welcome-state').classList.add('hidden');
      document.getElementById('tool-workspace').classList.remove('hidden');
      document.getElementById('current-tool-title').innerHTML = `<i class="${tool.icon} ${tool.color}"></i> ${tool.title}`;
      document.getElementById('current-tool-desc').innerText = tool.desc;
      // Build Form
      const form = document.getElementById('dynamic-form');
      form.innerHTML = ''; // Clear existing
      tool.inputs.forEach(input => {
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        label.className = 'block text-xs font-semibold uppercase tracking-wider text-slate-400 mb-1.5';
        label.innerText = input.label;
        wrapper.appendChild(label);
        let inputEl;
        if (input.type === 'select') {
          inputEl = document.createElement('select');
          inputEl.className = 'w-full bg-slate-900/50 border border-darkborder rounded-lg px-3 py-2.5 text-sm text-white focus:outline-none focus:border-brand-500 focus:bg-slate-900 transition-colors appearance-none';
          input.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.innerText = opt.charAt(0).toUpperCase() + opt.slice(1).replace('_', ' ');
            if (opt === input.defaultValue) option.selected = true;
            inputEl.appendChild(option);
          });
        } else if (input.type === 'textarea-list') {
          const listWrapper = document.createElement('div');
          listWrapper.id = `textarea-list-${input.id}`;
          listWrapper.className = 'flex flex-col gap-3';
          const addTextArea = () => {
            const areaWrap = document.createElement('div');
            areaWrap.className = 'relative group';
            const area = document.createElement('textarea');
            area.className = 'w-full bg-slate-900/50 border border-darkborder rounded-lg py-2.5 px-3 text-sm text-white focus:outline-none focus:border-indigo-500 focus:bg-slate-900 transition-colors resize-y min-h-[80px] textarea-list-item';
            area.placeholder = 'ماذا يحدث حالياً؟!';
            const removeBtn = document.createElement('button');
            removeBtn.className = 'absolute top-2 right-2 text-rose-400 hover:text-rose-300 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800/80 rounded-md p-1';
            removeBtn.innerHTML = '<i class="fa-solid fa-xmark text-xs"></i>';
            removeBtn.onclick = (e) => { e.preventDefault(); areaWrap.remove(); };
            areaWrap.appendChild(area);
            areaWrap.appendChild(removeBtn);
            listWrapper.appendChild(areaWrap);
          };
          // Add first initial textarea
          addTextArea();
          const addBtn = document.createElement('button');
          addBtn.type = 'button';
          addBtn.className = 'self-start mt-2 text-xs font-semibold text-indigo-400 bg-indigo-500/10 hover:bg-indigo-500/20 px-3 py-1.5 rounded-md transition-colors flex items-center gap-2';
          addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> إضافة تغريدة أخرى';
          addBtn.onclick = addTextArea;
          wrapper.appendChild(listWrapper);
          wrapper.appendChild(addBtn);
          inputEl = listWrapper; // Dummy assignment so it gets appended below
        } else if (input.type === 'checkbox') {
          wrapper.className = 'flex items-center gap-3 bg-slate-900/30 p-3 rounded-lg border border-darkborder/50';
          inputEl = document.createElement('input');
          inputEl.type = 'checkbox';
          inputEl.className = 'w-4 h-4 text-brand-500 bg-slate-900 border-darkborder rounded focus:ring-brand-500 focus:ring-offset-darkcard focus:ring-2';
          inputEl.checked = input.defaultValue;
          wrapper.innerHTML = '';
          wrapper.appendChild(inputEl);
          const chkLabel = document.createElement('label');
          chkLabel.className = 'text-sm font-medium text-slate-300 select-none cursor-pointer';
          chkLabel.innerText = input.label;
          wrapper.appendChild(chkLabel);
        } else {
          const inputWrapper = document.createElement('div');
          inputWrapper.className = 'relative flex items-center';
          if (input.prepend) {
            const prepend = document.createElement('span');
            prepend.className = 'absolute left-3 text-slate-500 font-medium select-none';
            prepend.innerText = input.prepend;
            inputWrapper.appendChild(prepend);
          } else if (input.icon) {
            const icon = document.createElement('i');
            icon.className = `${input.icon} absolute left-3 text-slate-500`;
            inputWrapper.appendChild(icon);
          }
          inputEl = document.createElement('input');
          inputEl.type = input.type;
          inputEl.placeholder = input.placeholder || '';
          inputEl.className = `w-full bg-slate-900/50 border border-darkborder rounded-lg py-2.5 text-sm text-white focus:outline-none focus:border-brand-500 focus:bg-slate-900 transition-colors placeholder-slate-600 ${input.prepend || input.icon ? 'pl-8 pr-3' : 'px-3'}`;
          if (input.defaultValue !== undefined) inputEl.value = input.defaultValue;
          inputWrapper.appendChild(inputEl);
          wrapper.appendChild(inputWrapper);
        }
        inputEl.id = `input-${input.id}`;
        if (input.type !== 'textarea-list') {
          inputEl.name = input.id;
          if (input.required) inputEl.required = true;
        }
        if (input.type !== 'checkbox') form.appendChild(wrapper);
        else form.appendChild(wrapper);
      });
      // Run Button color based on tool type
      const runBtn = document.getElementById('run-btn');
      if (tool.type === 'action') {
        runBtn.className = 'w-full relative group overflow-hidden rounded-xl bg-orange-600 hover:bg-orange-500 text-white font-medium py-3 px-4 shadow-lg shadow-orange-500/25 transition-all transform hover:-translate-y-0.5';
        document.getElementById('run-btn-text').innerText = 'تشغيل الأتمتة';
      } else {
        runBtn.className = 'w-full relative group overflow-hidden rounded-xl bg-brand-600 hover:bg-brand-500 text-white font-medium py-3 px-4 shadow-lg shadow-brand-500/25 transition-all transform hover:-translate-y-0.5';
        document.getElementById('run-btn-text').innerText = 'بدء الاستخراج';
      }
      // Clean Terminal
      printToTerminal('جاهز. تم التهيئة لـ ' + tool.title, 'info');
      document.getElementById('export-controls').style.display = 'none';
    }
    // Execute API Call
    async function executeTool() {
      if (!currentToolId) return;
      const tool = tools[currentToolId];
      // Regular inputs
      const formInputs = document.querySelectorAll('#dynamic-form input, #dynamic-form select');
      let params = {};
      let isValid = true;
      formInputs.forEach(input => {
        if (input.required && !input.value.trim()) {
          input.classList.add('border-red-500');
          isValid = false;
        } else {
          input.classList.remove('border-red-500');
        }
        if (input.type === 'checkbox') {
          params[input.name] = input.checked;
        } else {
          params[input.name] = input.value.trim();
        }
      });

      // Textarea List Inputs (e.g., Auto Poster)
      if (tool.inputs.some(i => i.type === 'textarea-list')) {
        const listItems = document.querySelectorAll('.textarea-list-item');
        let combinedText = [];
        listItems.forEach(area => {
          const val = area.value.trim();
          if (val) combinedText.push(val);
        });

        if (combinedText.length === 0) {
          isValid = false;
          // Highlight first one
          if (listItems[0]) listItems[0].classList.add('border-red-500');
        } else {
          // Combine with the separator expected by autoPoster.js
          params['tweets'] = combinedText.join('\n---\n');
        }
      }
      if (!isValid) return printToTerminal('خطأ: يرجى ملء جميع الحقول المطلوبة.', 'error');
      const token = localStorage.getItem('xactions_auth_token');
      if (tool.requiresAuth && !token) {
        return printToTerminal('خطأ: تتطلب هذه الأداة رمز auth_token الخاص بـ X.com. يرجى إعداده من القائمة العلوية.', 'error');
      }
      // UI Loading state
      const runBtn = document.getElementById('run-btn');
      const originalBtnHtml = runBtn.innerHTML;
      runBtn.disabled = true;
      runBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري تنفيذ المهمة...';
      printToTerminal(`[${new Date().toLocaleTimeString()}] بدء تشغيل ${tool.title}...`, 'info');
      try {
        let url = tool.endpoint;
        let fetchOptions = {
          method: tool.method,
          headers: { 'Content-Type': 'application/json' }
        };
        if (token) {
          fetchOptions.headers['x-auth-token'] = token;
        }
        if (tool.method === 'GET') {
          const searchParams = new URLSearchParams(params);
          url += `?${searchParams.toString()}`;
        } else {
          fetchOptions.body = JSON.stringify({
            scriptName: tool.scriptName,
            options: params
          });
        }
        const response = await fetch(url, fetchOptions);
        const result = await response.json();
        if (result.success) {
          lastResultData = result.data || result.message;
          const isObj = typeof lastResultData === 'object';
          document.getElementById('export-controls').style.display = isObj ? 'flex' : 'none';
          if (isObj) {
            const formattedJSON = syntaxHighlightJSON(JSON.stringify(lastResultData, null, 2));
            document.getElementById('terminal-output').innerHTML = `<pre><code>${formattedJSON}</code></pre>`;
          } else {
            printToTerminal(lastResultData, 'success');
          }
        } else {
          printToTerminal(`خطأ في API: ${result.error}`, 'error');
        }
      } catch (err) {
        printToTerminal(`خطأ في الشبكة/النظام: ${err.message}`, 'error');
      } finally {
        runBtn.disabled = false;
        runBtn.innerHTML = originalBtnHtml;
      }
    }
    // Terminal Helpers
    function printToTerminal(text, type = 'normal') {
      const terminal = document.getElementById('terminal-output');
      let color = 'text-slate-300';
      let icon = '';
      if (type === 'error') { color = 'text-red-400'; icon = '<i class="fa-solid fa-circle-xmark mr-2"></i>'; }
      if (type === 'success') { color = 'text-green-400'; icon = '<i class="fa-solid fa-check mr-2"></i>'; }
      if (type === 'info') { color = 'text-blue-400'; icon = '<i class="fa-solid fa-info-circle mr-2"></i>'; }
      terminal.innerHTML = `<div class="${color} flex items-start">${icon}<span>${text}</span></div>`;
    }
    // Auth Token Management
    function saveAuthToken() {
      const input = document.getElementById('global-auth-token');
      const token = input.value.trim();
      if (token) {
        localStorage.setItem('xactions_auth_token', token);
        checkAuthToken();
        input.value = ''; // clear
      }
    }
    function checkAuthToken() {
      const hasToken = !!localStorage.getItem('xactions_auth_token');
      const badge = document.getElementById('auth-status-badge');
      if (hasToken) {
        badge.className = 'px-2 py-1 rounded-md text-xs font-medium bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 flex items-center gap-1.5';
        badge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.8)]"></span> محدد ونشط';
      } else {
        badge.className = 'px-2 py-1 rounded-md text-xs font-medium bg-slate-800 border border-darkborder text-slate-400 flex items-center gap-1.5';
        badge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> غير محدد';
      }
    }
    // Export Utilities
    function copyResults() {
      if (lastResultData) {
        navigator.clipboard.writeText(JSON.stringify(lastResultData, null, 2))
          .then(() => alert('تم نسخ النتائج إلى الحافظة!'));
      }
    }
    function downloadJSON() {
      if (lastResultData) {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(lastResultData, null, 2));
        const dlAnchorElem = document.createElement('a');
        dlAnchorElem.setAttribute("href", dataStr);
        const fileName = `xactions_${currentToolId}_${new Date().getTime()}.json`;
        dlAnchorElem.setAttribute("download", fileName);
        dlAnchorElem.click();
      }
    }
    // JSON Highlighting Logic
    function syntaxHighlightJSON(json) {
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }
  </script>
</body>

</html>